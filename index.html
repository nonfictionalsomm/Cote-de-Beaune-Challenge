<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Côte de Beaune: A Wine Master's Challenge</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .modal-content {
            max-height: 80vh;
        }
        .prose-purple a {
            color: #9333ea;
        }
        .prose-purple a:hover {
            color: #7e22ce;
        }
        .timeline-item.selected {
            background-color: #6b21a8;
            color: white;
        }
        .flashcard-container {
            perspective: 1000px;
        }
        .flashcard {
            width: 100%;
            height: 100%;
            position: relative;
            transform-style: preserve-3d;
            transition: transform 0.6s;
        }
        .flashcard.is-flipped {
            transform: rotateY(180deg);
        }
        .flashcard-face {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2rem;
            border-radius: 0.5rem;
            text-align: center;
        }
        .flashcard-front {
            background-color: #374151; /* gray-700 */
        }
        .flashcard-back {
            background-color: #4b5563; /* gray-600 */
            transform: rotateY(180deg);
            overflow-y: auto;
        }
    </style>
</head>
<body class="bg-gray-900 text-white">

    <!-- Main Menu Screen -->
    <div id="main-menu" class="min-h-screen flex flex-col items-center justify-center p-4">
        <h1 class="text-4xl md:text-5xl font-bold text-purple-400 mb-2 text-center">Côte de Beaune</h1>
        <h2 class="text-2xl md:text-3xl font-semibold mb-8 text-center">A Wine Master's Challenge</h2>

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 w-full max-w-4xl mb-8">
            <button data-module="historian" class="module-btn bg-gray-800 p-6 rounded-lg hover:bg-purple-700 transition-colors duration-300">
                <h3 class="text-xl font-bold mb-2">The Historian's Scroll</h3>
                <p class="text-gray-400">Order the key events that shaped the Côte de Beaune.</p>
            </button>
            <button data-module="terroir" class="module-btn bg-gray-800 p-6 rounded-lg hover:bg-purple-700 transition-colors duration-300">
                <h3 class="text-xl font-bold mb-2">The Terroir Architect</h3>
                <p class="text-gray-400">Master the soils, climate, and geography.</p>
            </button>
            <button data-module="ampelographer" class="module-btn bg-gray-800 p-6 rounded-lg hover:bg-purple-700 transition-colors duration-300">
                <h3 class="text-xl font-bold mb-2">The Ampelographer's Challenge</h3>
                <p class="text-gray-400">Identify the region's key grape varieties and clones.</p>
            </button>
            <button data-module="lawmaker" class="module-btn bg-gray-800 p-6 rounded-lg hover:bg-purple-700 transition-colors duration-300">
                <h3 class="text-xl font-bold mb-2">The Lawmaker's Desk</h3>
                <p class="text-gray-400">Navigate the complexities of AOC law and winemaking regulations.</p>
            </button>
            <button data-module="gastronome" class="module-btn bg-gray-800 p-6 rounded-lg hover:bg-purple-700 transition-colors duration-300">
                <h3 class="text-xl font-bold mb-2">The Gastronome's Table</h3>
                <p class="text-gray-400">Explore classic food pairings and local cuisine.</p>
            </button>
            <button data-module="critic" class="module-btn bg-gray-800 p-6 rounded-lg hover:bg-purple-700 transition-colors duration-300">
                <h3 class="text-xl font-bold mb-2">The Critic's Corner</h3>
                <p class="text-gray-400">Analyze vintages and iconic producers.</p>
            </button>
        </div>

        <div class="w-full max-w-4xl">
             <button data-module="flashcard" class="module-btn bg-gray-800 p-6 rounded-lg hover:bg-purple-700 transition-colors duration-300 w-full">
                <h3 class="text-xl font-bold mb-2">Flashcard Study</h3>
                <p class="text-gray-400">Build your knowledge with targeted review.</p>
            </button>
        </div>
    	
        <button id="ai-settings-btn" class="mt-8 bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded">
            ⚙️ AI Settings
        </button>
    </div>

    <!-- Game Screen -->
    <div id="game-screen" class="hidden min-h-screen flex flex-col items-center justify-center p-4">
        <!-- Content will be injected here -->
    </div>

    <!-- Modals -->
    <div id="modal-container" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50 hidden">
        <div id="modal-content-wrapper" class="bg-gray-800 rounded-lg shadow-xl w-full max-w-2xl modal-content overflow-y-auto">
            <!-- Modal content will be injected here -->
        </div>
    </div>

    <script>
        // This object contains all the questions for the quiz modules, derived from the Côte de Beaune master documents.
        const gameData = {
            historian: {
                title: "The Historian's Scroll",
                instructions: "For each of the 5 challenges, arrange the historical events in chronological order from earliest to latest. Tap an event to add it to your timeline, then submit your answer.",
                questions: [
                    {
                        question: "Arrange these foundational events in Burgundy's history.",
                        events: [
                            { text: "The earliest literary evidence of viticulture in Burgundy is recorded in a panegyric to Emperor Constantine.", date: 312 },
                            { text: "The Burgundians, a Scandinavian tribe, found a kingdom in the Rhône Valley.", date: 456 },
                            { text: "King Guntramn gives a vineyard to the Abbey of St Benignus at Dijon, an early monastic holding.", date: 587 },
                            { text: "The Abbey of Cluny is founded, beginning the Benedictine reform and large-scale vineyard ownership.", date: 910 },
                            { text: "The Cistercian order is founded at Cîteaux, east of Nuits-St-Georges.", date: 1098 },
                        ]
                    },
                    {
                        question: "Order the key events of the Cistercian and Ducal periods.",
                        events: [
                            { text: "The Cistercians of Pontigny purchase vineyards from Benedictine monks, creating the first Chablis.", date: 1118 },
                            { text: "The Duchess of Burgundy grants the Abbey of St-Vivant the vineyards now known as Romanée-Conti and Richebourg.", date: 1232 },
                            { text: "The Cistercians complete the acquisition of the land that forms the walled Clos de Vougeot.", date: 1336 },
                            { text: "The Valois Dukes begin their rule of Burgundy, elevating its wines to a symbol of status.", date: 1363 },
                            { text: "Philip the Bold issues a decree banning the 'disloyal' Gamay grape from the Côte d'Or.", date: 1395 },
                        ]
                    },
                    {
                        question: "Place these crucial developments from the Renaissance to the Revolution in order.",
                        events: [
                            { text: "Nicolas Rolin, Chancellor to the Duke, founds the charitable Hôtel Dieu (Hospices de Beaune).", date: 1443 },
                            { text: "The death of Charles the Rash leads to Burgundy's reincorporation into the kingdom of France.", date: 1477 },
                            { text: "The first major négociant house, Champy, is founded in Beaune.", date: 1720 },
                            { text: "Claude Arnoux publishes the first major work on Burgundy wines, noting the fame of Volnay's 'Œil-de-Perdrix'.", date: 1728 },
                            { text: "The French Revolution begins, leading to the seizure and auctioning of Church and nobility vineyard holdings.", date: 1789 },
                        ]
                    },
                    {
                        question: "Sequence these key events of the 19th century.",
                        events: [
                            { text: "Napoléon's Civil Code is established, mandating equal inheritance and causing vineyard fragmentation.", date: 1804 },
                            { text: "The Paris-Dijon railway opens, dramatically improving transport and access to markets.", date: 1851 },
                            { text: "Dr. Jules Lavalle publishes his influential classification of the Côte d'Or's vineyards.", date: 1855 },
                            { text: "The Beaune Committee of Agriculture formalizes Lavalle's work, creating a three-class vineyard hierarchy.", date: 1861 },
                            { text: "Phylloxera is officially acknowledged in the Côte d'Or after an infested Meursault vineyard is quarantined.", date: 1878 },
                        ]
                    },
                    {
                        question: "Arrange these key moments in the establishment of the modern AOC system.",
                        events: [
                            { text: "The first domaine bottlings are pioneered by figures like Marquis d'Angerville and Henri Gouges.", date: 1930 },
                            { text: "The INAO is created, establishing the Appellation d'Origine Contrôlée (AOC) system.", date: 1935 },
                            { text: "The AOC for Beaune is officially established by decree.", date: 1936 },
                            { text: "A large number of key village AOCs, including Volnay, Pommard, and Meursault, are officially recognized.", date: 1937 },
                            { text: "The Corton and Corton-Charlemagne Grand Cru AOCs are established.", date: 1937 },
                        ]
                    },
                    {
                        question: "Order these events related to the Hospices de Beaune and post-war developments.",
                        events: [
                            { text: "Nicolas Rolin founds the Hôtel Dieu to care for the poor.", date: 1443 },
                            { text: "The first donation of vineyards is made to the Hospices de Beaune.", date: 1457 },
                            { text: "The first annual charity wine auction of the Hospices de Beaune is held.", date: 1859 },
                            { text: "Comte Jules Lafon revives the Paulée de Meursault, an end-of-harvest feast.", date: 1920 },
                            { text: "The Confrérie des Chevaliers du Tastevin is established at the Château du Clos de Vougeot.", date: 1945 },
                        ]
                    },
                    {
                        question: "Sequence the establishment of these key Grand Cru appellations.",
                        events: [
                            { text: "Corton and Corton-Charlemagne AOCs are established.", date: 1937 },
                            { text: "Montrachet and Bâtard-Montrachet AOCs are established.", date: 1937 },
                            { text: "Chevalier-Montrachet AOC is established.", date: 1937 },
                            { text: "Bienvenues-Bâtard-Montrachet AOC is established.", date: 1939 },
                            { text: "Criots-Bâtard-Montrachet AOC is established.", date: 1939 },
                        ]
                    },
                    {
                        question: "Arrange these milestones related to transport and trade in Burgundy.",
                        events: [
                            { text: "The papal court moves to Avignon, creating a huge demand for the wines of 'Beaune'.", date: 1305 },
                            { text: "The first négociant houses, such as Champy and Bouchard, are established in Beaune.", date: 1720 },
                            { text: "A canal system opens in Burgundy, improving the transport of wine.", date: 1830 },
                            { text: "The Paris-Dijon railway line opens, revolutionizing the wine trade.", date: 1851 },
                            { text: "By 1990, nearly half of all Côte d'Or wines are domaine-bottled, a major shift from négociant dominance.", date: 1990 },
                        ]
                    },
                    {
                        question: "Order these key moments in the history of the Hill of Corton.",
                        events: [
                            { text: "First references to vineyards in Aloxe-Corton are recorded.", date: 696 },
                            { text: "Emperor Charlemagne gives vines on the hill to the Abbey of Saulieu.", date: 775 },
                            { text: "The Grand Cru appellations of Corton and Corton-Charlemagne are officially created.", date: 1937 },
                            { text: "Domaine Bonneau du Martray becomes a leading producer of Corton-Charlemagne.", date: 1969 },
                            { text: "Domaine de la Romanée-Conti begins producing wine from its leased parcels in Corton.", date: 2009 },
                        ]
                    },
                    {
                        question: "Sequence these events that shaped the ownership and structure of Burgundy's vineyards.",
                        events: [
                            { text: "The Abbey of Cluny is founded, beginning a long era of monastic vineyard consolidation.", date: 910 },
                            { text: "The French Revolution leads to the nationalization and sale of church-owned vineyards.", date: 1791 },
                            { text: "The Napoleonic Code mandates equal inheritance, initiating the extreme fragmentation of vineyard holdings.", date: 1804 },
                            { text: "The phylloxera epidemic destroys most vineyards, forcing a complete replanting on American rootstock.", date: 1878 },
                            { text: "The concept of a 'monopole' (a vineyard owned by a single entity) becomes a mark of prestige.", date: 1950 },
                        ]
                    }
                ]
            },
            terroir: {
                title: "The Terroir Architect",
                instructions: "Answer 10 multiple-choice questions about the geology, geography, and climate of the Côte de Beaune.",
                questions: [
                    // This is a sample of the 100 questions that would be generated.
                    { q: "The entire Côte d'Or is a fault scarp created by the collapse of what geographical feature?", a: "The Saône Plain", o: ["The Paris Basin", "The Massif Central", "The Rhône Valley"] },
                    { q: "The parent rock of the Côte de Beaune's best vineyards dates to which geological period?", a: "Jurassic", o: ["Cretaceous", "Triassic", "Tertiary"] },
                    { q: "What is the primary geological difference between the soils of Pommard (ideal for Pinot Noir) and Meursault (ideal for Chardonnay)?", a: "Pommard has more argillaceous limestone (clay-limestone), while Meursault has more marly limestone.", o: ["Pommard has granite soils, while Meursault has schist.", "Pommard has alluvial soils, while Meursault has volcanic tuff.", "There is no significant geological difference."] },
                    { q: "The prime vineyard sites of the Côte de Beaune are typically found at what altitude range?", a: "220 to 370 meters", o: ["100 to 200 meters", "400 to 500 meters", "Below 150 meters"] },
                    { q: "What is the dominant aspect (directional exposure) of the Premier and Grand Cru vineyards in the Côte de Beaune?", a: "East / South-East", o: ["West / South-West", "North", "Due South"] },
                    { q: "The reddish color of soils in appellations like Corton and Pommard is due to the presence of what?", a: "Iron Oxide (Oolitic Iron)", o: ["Copper Sulfate", "Magnesium", "High levels of sand"] },
                    { q: "What is the most significant annual viticultural risk in the Côte de Beaune, often leading to drastically reduced yields?", a: "Spring Frost", o: ["Summer Drought", "Autumn Hail", "Winter Freeze"] },
                    { q: "The calculated Growing Degree Days (GDD) for Beaune places it in which Winkler climate region, ideal for Pinot Noir and Chardonnay?", a: "Region II", o: ["Region I", "Region III", "Region IV"] },
                    { q: "The hard Comblanchien limestone layer dips underground near which village, allowing the softer Argovian marls to surface and creating a shift from red to white wine production?", a: "Volnay", o: ["Aloxe-Corton", "Santenay", "Pommard"] },
                    { q: "In which village are the soils noted for being particularly stony, with a high content of limestone debris known as 'chaillots'?", a: "Aloxe-Corton", o: ["Chorey-lès-Beaune", "Santenay", "Maranges"] },
                    // ... 90 more questions would follow, covering all aspects of terroir from the documents.
                ]
            },
            ampelographer: {
                title: "The Ampelographer's Challenge",
                instructions: "Answer 10 multiple-choice questions about the key grape varieties, clones, and viticultural practices of the Côte de Beaune. After a correct answer, you may have the option to generate an AI profile.",
                questions: [
                    // This is a sample of the 100 questions that would be generated.
                    { q: "What is the legally mandated minimum planting density for most Premier and Grand Cru vineyards in the Côte de Beaune?", a: "9,000 - 10,000 vines per hectare", o: ["5,000 - 6,000 vines/ha", "7,000 - 8,000 vines/ha", "12,000 - 15,000 vines/ha"] },
                    { q: "What is the overwhelmingly dominant vine training system used in the Côte de Beaune?", a: "Guyot (Simple or Double)", o: ["Cordon de Royat", "Goblet (Bush Vine)", "Lyre"] },
                    { q: "What is the primary reason irrigation is strictly forbidden in all AOC vineyards in Burgundy?", a: "To force vines to develop deep roots to express terroir.", o: ["To conserve water in a dry climate.", "To prevent the spread of disease.", "Because the high rainfall makes it unnecessary."] },
                    { q: "The famous 'Dijon clones' of Pinot Noir (e.g., 115, 667, 777) were developed at which institution?", a: "The University of Dijon", o: ["The University of Montpellier", "The Geisenheim Institute", "UC Davis"] },
                    { q: "While Chardonnay is dominant, what other white grape variety is permitted in the blend for Meursault AOC?", a: "Pinot Blanc", o: ["Aligoté", "Sauvignon Blanc", "Melon de Bourgogne"] },
                    { q: "The propagation of new vines from cuttings of numerous superior, older vines in a single vineyard is known as what?", a: "Sélection Massale", o: ["Clonal Selection", "Grafting", "Layering"] },
                    { q: "Which red grape is the primary component of the Bourgogne Passe-Tout-Grains AOC?", a: "Pinot Noir", o: ["Gamay", "César", "Tressot"] },
                    { q: "Chardonnay is a natural crossing of Pinot and which other, now obscure, grape variety?", a: "Gouais Blanc", o: ["Aligoté", "Sacy", "Tressot"] },
                    { q: "Which viticultural hazard, caused by poor weather during flowering, results in a mix of small, seedless berries and normal berries in a cluster?", a: "Millerandage", o: ["Coulure", "Shatter", "Veraison"] },
                    { q: "In which village is a small but notable amount of Pinot Blanc co-planted with Chardonnay?", a: "Meursault", o: ["Pommard", "Volnay", "Corton"] },
                    // ... 90 more questions would follow.
                ]
            },
            lawmaker: {
                title: "The Lawmaker's Desk",
                instructions: "Answer 10 multiple-choice questions about the appellation laws and winemaking regulations of the Côte de Beaune.",
                questions: [
                    // This is a sample of the 100 questions that would be generated.
                    { q: "Which of the following is the only Grand Cru for red wine in the Côte de Beaune?", a: "Corton", o: ["Clos des Mouches", "Les Rugiens", "Montrachet"] },
                    { q: "A red wine from the Premier Cru 'Les Santenots' in Meursault must be labeled under which village appellation?", a: "Volnay", o: ["Meursault", "Pommard", "Auxey-Duresses"] },
                    { q: "What is the term for a vineyard, such as Clos des Epeneaux in Pommard, that is owned entirely by a single producer?", a: "Monopole", o: ["Climat", "Lieu-dit", "Clos"] },
                    { q: "The Côte de Beaune-Villages AOC can be used for red wines from most villages in the Côte de Beaune EXCEPT for which four?", a: "Aloxe-Corton, Beaune, Pommard, and Volnay", o: ["Meursault, Puligny, Chassagne, and Santenay", "Savigny, Chorey, Ladoix, and Pernand", "Saint-Romain, Saint-Aubin, Monthélie, and Maranges"] },
                    { q: "What is the smallest Grand Cru appellation in the Côte de Beaune, located entirely within Chassagne-Montrachet?", a: "Criots-Bâtard-Montrachet", o: ["La Romanée", "Chevalier-Montrachet", "Bienvenues-Bâtard-Montrachet"] },
                    { q: "What is the maximum base yield (in hl/ha) for a red Corton Grand Cru?", a: "42 hl/ha", o: ["35 hl/ha", "50 hl/ha", "48 hl/ha"] },
                    { q: "The practice of adding sugar to the must to increase potential alcohol, which is legally permitted in Burgundy, is called what?", a: "Chaptalization", o: ["Acidification", "Bâtonnage", "Débourbage"] },
                    { q: "Which two villages share ownership of the Montrachet Grand Cru vineyard?", a: "Puligny-Montrachet and Chassagne-Montrachet", o: ["Meursault and Puligny-Montrachet", "Volnay and Meursault", "Chassagne-Montrachet and Santenay"] },
                    { q: "The use of wood chips for aging is what in all Burgundy AOCs?", a: "Strictly forbidden", o: ["Permitted for Village wines only", "Permitted for regional wines only", "Allowed if declared on the label"] },
                    { q: "The appellation 'Blagny' is reserved for red wines only. White wines from the same area must be labeled as what?", a: "Meursault or Puligny-Montrachet, depending on the plot", o: ["Saint-Aubin", "Blagny Blanc", "Côte de Beaune"] },
                    // ... 90 more questions would follow.
                ]
            },
            gastronome: {
                title: "The Gastronome's Table",
                instructions: "Answer 10 multiple-choice questions about the cuisine, ingredients, and classic pairings of the Côte de Beaune. After a correct answer, you may have the option to generate an AI explanation.",
                questions: [
                    // This is a sample of the 100 questions that would be generated.
                    { q: "What is the classic Burgundian dish of beef slow-cooked in red wine, mushrooms, and onions?", a: "Boeuf Bourguignon", o: ["Coq au Vin", "Pot-au-Feu", "Daube Provençale"], subjectType: 'dish', subjectName: 'Boeuf Bourguignon' },
                    { q: "Époisses de Bourgogne, a famous pungent cheese, is washed with what local spirit during its aging process?", a: "Marc de Bourgogne", o: ["Crème de Cassis", "Fine de Bourgogne", "Absinthe"], subjectType: 'ingredient', subjectName: 'Époisses de Bourgogne' },
                    { q: "The classic apéritif 'Kir' is made by mixing Crème de Cassis with which specific Burgundy wine?", a: "Bourgogne Aligoté", o: ["Crémant de Bourgogne", "Meursault", "Mâcon-Villages"], subjectType: 'wine_pairing', subjectName: 'Kir Cocktail' },
                    { q: "Which type of poultry, the only one in the world with its own AOC, is a prized ingredient in Burgundian cuisine?", a: "Bresse Chicken", o: ["Poularde de Bresse", "Canard de Challans", "Dinde de Bresse"], subjectType: 'ingredient', subjectName: 'Bresse Chicken' },
                    { q: "Jambon Persillé is a traditional starter consisting of cooked ham set in an aspic flavored with what herb?", a: "Parsley", o: ["Tarragon", "Chervil", "Thyme"], subjectType: 'dish', subjectName: 'Jambon Persillé' },
                    { q: "The powerful structure of a Premier Cru Pommard is considered a classic pairing for what type of food?", a: "Furred or feathered game", o: ["Delicate poached fish", "Spicy Asian cuisine", "Light salads"], subjectType: 'wine_pairing', subjectName: 'Pommard and Game' },
                    { q: "What is the name for the savory choux pastry puffs, typically made with Comté cheese, served as an apéritif?", a: "Gougères", o: ["Profiteroles", "Croquembouche", "Madeleines"], subjectType: 'dish', subjectName: 'Gougères' },
                    { q: "Crème de Cassis de Dijon, a PGI-protected liqueur, was invented in which city in 1841?", a: "Dijon", o: ["Beaune", "Nuits-Saint-Georges", "Mâcon"], subjectType: 'liqueur', subjectName: 'Crème de Cassis de Dijon' },
                    { q: "The rich, buttery character of a classic Meursault is a perfect match for what luxurious seafood?", a: "Lobster or crawfish in sauce", o: ["Oysters on the half-shell", "Smoked salmon", "Salted cod"], subjectType: 'wine_pairing', subjectName: 'Meursault and Lobster' },
                    { q: "What is Marc de Bourgogne?", a: "A pomace brandy distilled from grape skins, seeds, and stems.", o: ["A sweet, fortified red wine.", "A liqueur made from cherries.", "A type of beer brewed with grape must."], subjectType: 'spirit', subjectName: 'Marc de Bourgogne' },
                    // ... 90 more questions would follow.
                ]
            },
            critic: {
                title: "The Critic's Corner",
                instructions: "Answer 10 multiple-choice questions about the vintages, producers, and market context of the Côte de Beaune. After a correct answer, you may have the option to generate an AI tasting note.",
                questions: [
                    // This is a sample of the 100 questions that would be generated.
                    { q: "Which Meursault-based domaine is considered a global benchmark for Chardonnay, known for its incredibly long-lived and expensive wines?", a: "Domaine Coche-Dury", o: ["Domaine Leflaive", "Domaine Ramonet", "Domaine de la Romanée-Conti"], subjectType: 'producer', subjectName: 'Domaine Coche-Dury' },
                    { q: "Which vintage is widely considered a modern benchmark for classic, age-worthy red and white Burgundy, known for its concentration and perfect balance?", a: "2010", o: ["2009", "2011", "2003"], subjectType: 'vintage', subjectName: '2010 Burgundy Vintage' },
                    { q: "The Marquis d'Angerville is an iconic, benchmark producer based in which village, famous for its elegant Premier Cru monopoles?", a: "Volnay", o: ["Pommard", "Meursault", "Puligny-Montrachet"], subjectType: 'producer', subjectName: 'Domaine Marquis d\'Angerville' },
                    { q: "The 2003 vintage in Burgundy is infamous for what extreme weather event, resulting in atypical, low-acid wines?", a: "A severe heatwave", o: ["Widespread frost", "Devastating hail", "Excessive rain"], subjectType: 'vintage', subjectName: '2003 Burgundy Vintage' },
                    { q: "Which producer owns the 5.23-hectare monopole 'Clos des Epeneaux' in Pommard?", a: "Comte Armand", o: ["Domaine de Montille", "Michel Lafarge", "Domaine de Courcel"], subjectType: 'producer', subjectName: 'Comte Armand Clos des Epeneaux' },
                    { q: "Which vintage is hailed as exceptional for white wines, producing taut, lean, and intensely mineral-driven Chardonnays?", a: "2014", o: ["2015", "2018", "2009"], subjectType: 'vintage', subjectName: '2014 Burgundy White Wine Vintage' },
                    { q: "The annual charity wine auction that serves as an economic bellwether for the new vintage is held by which institution?", a: "Hospices de Beaune", o: ["Confrérie des Chevaliers du Tastevin", "The INAO", "The BIVB"], subjectType: 'place', subjectName: 'Hospices de Beaune Wine Auction' },
                    { q: "Which Puligny-Montrachet domaine is a benchmark for biodynamic viticulture and produces some of the world's most sought-after white wines?", a: "Domaine Leflaive", o: ["Domaine Sauzet", "Domaine Carillon", "Domaine Boillot"], subjectType: 'producer', subjectName: 'Domaine Leflaive' },
                    { q: "Which of these villages is NOT considered one of the 'big three' for white wine production in the Côte de Beaune?", a: "Volnay", o: ["Meursault", "Puligny-Montrachet", "Chassagne-Montrachet"], subjectType: 'place', subjectName: 'Côte de Beaune White Wine Villages' },
                    { q: "The 2021 vintage in the Côte de Beaune was severely impacted by what event, leading to an extremely small crop of white wines?", a: "Devastating spring frosts", o: ["Summer drought", "Harvest rains", "Widespread hail"], subjectType: 'vintage', subjectName: '2021 Burgundy Vintage' },
                    // ... 90 more questions would follow.
                ]
            },
        };

        // This object contains comprehensive flashcard data, separate from the quiz questions.
        const flashcardData = {
            historian: [
                { q: "What year saw the first literary evidence of viticulture in Burgundy?", a: "312 CE" },
                { q: "In what year was the Abbey of Cluny founded, starting the Benedictine influence on vineyards?", a: "910" },
                { q: "When was the Cistercian order founded at Cîteaux?", a: "1098" },
                { q: "In what year did Philip the Bold, Duke of Burgundy, ban the Gamay grape?", a: "1395" },
                { q: "When was the Hospices de Beaune (Hôtel-Dieu) founded by Nicolas Rolin?", a: "1443" },
                { q: "What year did the French Revolution begin, leading to the sale of church vineyards?", a: "1789" },
                { q: "When was the Napoleonic Code established, causing vineyard fragmentation?", a: "1804" },
                { q: "In what year did Dr. Jules Lavalle publish his influential classification of Côte d'Or vineyards?", a: "1855" },
                { q: "When was phylloxera officially identified in the Côte d'Or?", a: "1878" },
                { q: "In what year was the INAO created, establishing the AOC system?", a: "1935" },
                { q: "When were most of the key Côte de Beaune village AOCs, like Pommard and Volnay, established?", a: "1937" },
                { q: "When was the Confrérie des Chevaliers du Tastevin established at the Château du Clos de Vougeot?", a: "1945" },
                // ... 38 more historian flashcards
            ],
            terroir: [
                { q: "What is the primary geological feature of the Côte d'Or?", a: "A fault scarp from the collapse of the Saône Plain." },
                { q: "What is the parent rock of the Côte de Beaune's best vineyards?", a: "Jurassic limestone and marl." },
                { q: "What soil type, rich in clay and iron, is ideal for Pinot Noir in villages like Pommard?", a: "Argillaceous limestone (clay-limestone)." },
                { q: "What soil type, rich in marl, is ideal for Chardonnay in villages like Meursault?", a: "Marly limestone." },
                { q: "What is the ideal altitude range for Premier and Grand Cru vineyards?", a: "220 to 370 meters." },
                { q: "What is the dominant aspect (exposure) of the great vineyards?", a: "East / South-East." },
                { q: "What is the climate type of the Côte de Beaune?", a: "Semi-continental." },
                { q: "What is the most significant and frequent climatic risk for growers?", a: "Spring frost." },
                { q: "What are 'chaillots'?", a: "Flinty limestone debris found in the soils of villages like Aloxe-Corton." },
                { q: "What is the name of the hill that hosts the Corton and Corton-Charlemagne Grands Crus?", a: "The Hill of Corton." },
                // ... 40 more terroir flashcards
            ],
            ampelographer: [
                { q: "What is the dominant red grape of the Côte de Beaune?", a: "Pinot Noir." },
                { q: "What is the dominant white grape of the Côte de Beaune?", a: "Chardonnay." },
                { q: "What is the legally required minimum vine density in most top appellations?", a: "9,000 - 10,000 vines per hectare." },
                { q: "What is the most common vine training system?", a: "Guyot (Simple or Double)." },
                { q: "What are the 'Dijon clones'?", a: "Specific, selected strains of Pinot Noir and Chardonnay developed at the University of Dijon for desirable traits." },
                { q: "What is 'sélection massale'?", a: "A traditional method of vineyard propagation using cuttings from a large number of superior old vines to maintain genetic diversity." },
                { q: "What is Burgundy's 'other' white grape, with its own regional AOC?", a: "Aligoté." },
                { q: "Is irrigation permitted in AOC vineyards?", a: "No, it is strictly forbidden." },
                { q: "What causes 'coulure'?", a: "Poor weather during flowering, which prevents grapes from developing." },
                { q: "What is the genetic origin of Chardonnay?", a: "A natural crossing of Pinot and Gouais Blanc." },
                // ... 40 more ampelographer flashcards
            ],
            lawmaker: [
                { q: "What do the letters AOC stand for?", a: "Appellation d'Origine Contrôlée." },
                { q: "What is a 'monopole'?", a: "A vineyard owned entirely by a single domaine." },
                { q: "Which Grand Cru is shared between Puligny-Montrachet and Chassagne-Montrachet?", a: "Montrachet and Bâtard-Montrachet." },
                { q: "What is the only red Grand Cru in the Côte de Beaune?", a: "Corton." },
                { q: "What is the purpose of the Côte de Beaune-Villages AOC?", a: "It is a red-wine-only appellation that can be used by 14 villages, often for blending or for wines from communes known for whites." },
                { q: "What is chaptalization?", a: "The legally permitted addition of sugar to the must to increase the final alcohol level, typically in cool vintages." },
                { q: "What is the highest classification a vineyard can have in Burgundy?", a: "Grand Cru." },
                { q: "A wine labeled 'Volnay 1er Cru Les Caillerets' comes from which level of the quality pyramid?", a: "Premier Cru." },
                { q: "What is the smallest white Grand Cru?", a: "Criots-Bâtard-Montrachet (1.57 ha)." },
                { q: "What is the largest Grand Cru in all of Burgundy?", a: "Corton (approx. 160 ha)." },
                // ... 40 more lawmaker flashcards
            ],
            gastronome: [
                { q: "What is Boeuf Bourguignon?", a: "A classic beef stew slow-cooked with red Burgundy wine." },
                { q: "What is the key ingredient in a Kir cocktail?", a: "Crème de Cassis and Bourgogne Aligoté." },
                { q: "What is Époisses?", a: "A famously pungent, soft, washed-rind cheese from Burgundy, often washed with Marc de Bourgogne." },
                { q: "What is Jambon Persillé?", a: "A traditional terrine of cooked ham in a parsley-flecked aspic." },
                { q: "What is the only AOC-protected poultry in the world, native to the region?", a: "Bresse Chicken." },
                { q: "What is Marc de Bourgogne?", a: "A pomace brandy distilled from the solid remains of grape pressing." },
                { q: "What are Gougères?", a: "Savory choux pastry puffs baked with cheese, served as an apéritif." },
                { q: "What is the classic wine pairing for Coq au Vin?", a: "Red Burgundy (Pinot Noir)." },
                { q: "What is the classic wine pairing for rich seafood like lobster?", a: "Full-bodied white Burgundy, such as Meursault." },
                { q: "What is the classic wine pairing for game meats like venison or boar?", a: "Powerful, structured red Burgundy, such as Pommard or Corton." },
                // ... 40 more gastronome flashcards
            ],
            critic: [
                { q: "Who is considered the most iconic producer of Meursault?", a: "Domaine Coche-Dury." },
                { q: "Which domaine is the benchmark for Volnay?", a: "Domaine Marquis d'Angerville." },
                { q: "Which vintage is famous for the extreme summer heatwave?", a: "2003." },
                { q: "Which vintage is considered a modern classic for both red and white wines, known for perfect balance and longevity?", a: "2010." },
                { q: "Which vintage is celebrated for producing exceptional, mineral-driven white wines?", a: "2014." },
                { q: "What is the name of the annual charity wine auction in Beaune?", a: "The Hospices de Beaune auction." },
                { q: "Who is the iconic producer of the Clos des Epeneaux monopole in Pommard?", a: "Comte Armand." },
                { q: "Which domaine is a leader in biodynamic viticulture in Puligny-Montrachet?", a: "Domaine Leflaive." },
                { q: "What does 'Burghound' refer to?", a: "The influential newsletter and website by critic Allen Meadows, a leading authority on Burgundy." },
                { q: "What is the general style difference between a Pommard and a Volnay?", a: "Pommard is typically more powerful, structured, and tannic, while Volnay is more elegant, aromatic, and silky." },
                // ... 40 more critic flashcards
            ]
        };

        const mainMenu = document.getElementById('main-menu');
        const gameScreen = document.getElementById('game-screen');
        const modalContainer = document.getElementById('modal-container');
        const modalContentWrapper = document.getElementById('modal-content-wrapper');
        const aiSettingsBtn = document.getElementById('ai-settings-btn');

        let currentModule;
        let currentQuestionIndex;
        let score;
        let questions = [];
        let userTimeline = [];
        let historianAvailableEvents = [];
        let flashcardDeck = [];
        let currentFlashcardIndex = 0;
        let userApiKey = localStorage.getItem('geminiApiKey') || '';

        // --- Event Listeners ---
        document.querySelectorAll('.module-btn').forEach(button => {
            button.addEventListener('click', () => {
                const module = button.dataset.module;
                if (module === 'flashcard') {
                    showFlashcardTopicSelection();
                } else {
                    showInstructionalModal(module);
                }
            });
        });

        aiSettingsBtn.addEventListener('click', showAiSettingsModal);
    	
        // --- Modal Functions ---
        function showModal(content) {
            modalContentWrapper.innerHTML = content;
            modalContainer.classList.remove('hidden');
        }

        function hideModal() {
            modalContainer.classList.add('hidden');
            modalContentWrapper.innerHTML = '';
        }
    	
        function showWelcomeModal() {
            if (sessionStorage.getItem('welcomed')) return;
            const content = `
                <div class="p-6">
                    <h2 class="text-2xl font-bold mb-4 text-purple-400">Welcome to the Gauntlet!</h2>
                    <p class="mb-4 text-gray-300">This is "Côte de Beaune: A Wine Master's Challenge," an interactive study game designed for advanced wine students.</p>
                    <p class="mb-6 text-gray-300">Test your knowledge across history, terroir, grapes, law, and more. All questions are derived from comprehensive research documents on the region. Good luck!</p>
                    <button onclick="closeWelcomeModal()" class="w-full bg-purple-700 hover:bg-purple-600 text-white font-bold py-2 px-4 rounded">Begin</button>
                </div>
            `;
            showModal(content);
        }

        function closeWelcomeModal() {
            sessionStorage.setItem('welcomed', 'true');
            hideModal();
        }

        function showInstructionalModal(module) {
            currentModule = module;
            const moduleData = gameData[module];
            
            // Check for mastery before showing instructions
            const allModuleQuestions = [...gameData[currentModule].questions];
            const correctLog = JSON.parse(localStorage.getItem('correctlyAnsweredQuestions')) || {};
            const correctQuestionsForModule = correctLog[currentModule] || [];
            
            if (module !== 'historian' && allModuleQuestions.length > 0 && correctQuestionsForModule.length >= allModuleQuestions.length) {
                const masteryContent = `
                    <div class="p-6 text-center">
                        <h2 class="text-2xl font-bold mb-4 text-green-400">Module Mastered!</h2>
                        <p class="mb-4 text-gray-300">Congratulations! You've correctly answered all questions in this module. Your progress will be reset so you can continue to sharpen your knowledge.</p>
                        <button onclick="resetAndStartGame()" class="w-full bg-purple-700 hover:bg-purple-600 text-white font-bold py-2 px-4 rounded">Play Again</button>
                    </div>
                `;
                showModal(masteryContent);
                return;
            }

            const content = `
                <div class="p-6">
                    <h2 class="text-2xl font-bold mb-4 text-purple-400">${moduleData.title}</h2>
                    <p class="mb-6 text-gray-300">${moduleData.instructions}</p>
                    <button onclick="startGame()" class="w-full bg-purple-700 hover:bg-purple-600 text-white font-bold py-2 px-4 rounded">Start Challenge</button>
                </div>
            `;
            showModal(content);
        }

        function showEndGameModal() {
            const moduleData = gameData[currentModule];
            const content = `
                <div class="p-6 text-center">
                    <h2 class="text-2xl font-bold mb-4 text-purple-400">Module Complete!</h2>
                    <p class="text-lg mb-2 text-gray-300">You completed "${moduleData.title}".</p>
                    <p class="text-4xl font-bold mb-6">Score: ${score} / ${questions.length}</p>
                    <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-4">
                        <button onclick="startGame()" class="w-full bg-purple-700 hover:bg-purple-600 text-white font-bold py-2 px-4 rounded">Keep Going</button>
                        <button onclick="returnToMenu()" class="w-full bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded">Main Menu</button>
                    </div>
                </div>
            `;
            showModal(content);
        }

        function showAiSettingsModal() {
            const content = `
                <div class="p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold text-purple-400">AI Settings</h2>
                        <button onclick="hideModal()" class="text-gray-400 hover:text-white text-2xl">&times;</button>
                    </div>
                    <p class="mb-4 text-gray-300">To use the AI-powered features, please enter your Google AI Studio API key. You can get a key at <a href="https://aistudio.google.com/app/apikey" target="_blank" class="text-purple-400 hover:underline">aistudio.google.com/app/apikey</a>.</p>
                    <p class="text-sm text-yellow-400 mb-4">Security Reminder: Treat your API key like a password. It is saved in your browser's local storage for convenience but is not transmitted anywhere else.</p>
                    <div class="mb-4">
                        <label for="api-key-input" class="block text-sm font-medium text-gray-300 mb-1">Google AI API Key</label>
                        <input type="password" id="api-key-input" class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-white" value="${userApiKey}">
                    </div>
                    <button onclick="saveApiKey()" class="w-full bg-purple-700 hover:bg-purple-600 text-white font-bold py-2 px-4 rounded">Save and Close</button>
                </div>
            `;
            showModal(content);
        }
    	
        function saveApiKey() {
            userApiKey = document.getElementById('api-key-input').value;
            localStorage.setItem('geminiApiKey', userApiKey);
            hideModal();
        }

        // --- Game Flow ---
        function startGame() {
            hideModal();
            mainMenu.classList.add('hidden');
            gameScreen.classList.remove('hidden');
            score = 0;
            currentQuestionIndex = 0;

            if (currentModule === 'historian') {
                questions = shuffleArray([...gameData.historian.questions]).slice(0, 5);
                loadHistorianQuestion();
            } else {
                const allModuleQuestions = [...gameData[currentModule].questions];
                const correctLog = JSON.parse(localStorage.getItem('correctlyAnsweredQuestions')) || {};
                const correctQuestionsForModule = correctLog[currentModule] || [];
                let availableQuestions = allModuleQuestions.filter(q => !correctQuestionsForModule.includes(q.q));
                
                if (availableQuestions.length === 0 && allModuleQuestions.length > 0) {
                     // This case is now handled in showInstructionalModal to prevent starting a mastered module.
                     // But as a fallback, we'll just reset and start.
                     resetAndStartGame();
                     return;
                }
            	
                questions = shuffleArray(availableQuestions).slice(0, 10);
                loadQuestion();
            }
        }

        function resetAndStartGame() {
            let correctLog = JSON.parse(localStorage.getItem('correctlyAnsweredQuestions')) || {};
            correctLog[currentModule] = [];
            localStorage.setItem('correctlyAnsweredQuestions', JSON.stringify(correctLog));
            startGame();
        }

        function returnToMenu() {
            hideModal();
            gameScreen.classList.add('hidden');
            mainMenu.classList.remove('hidden');
            gameScreen.innerHTML = '';
            checkGlobalMastery();
        }

        // --- Multiple Choice Logic ---
        function loadQuestion() {
            if (questions.length === 0 || currentQuestionIndex >= questions.length) {
                showEndGameModal();
                return;
            }

            const q = questions[currentQuestionIndex];
            const options = shuffleArray([q.a, ...q.o]);
        	
            gameScreen.innerHTML = `
                <div class="w-full max-w-3xl">
                    <div class="flex justify-between items-center mb-2">
                        <button onclick="returnToMenu()" class="bg-gray-700 hover:bg-gray-600 text-white font-bold py-1 px-3 rounded text-sm">← Menu</button>
                        <p class="text-right text-gray-400">${currentQuestionIndex + 1} / ${questions.length} | Score: ${score}</p>
                    </div>
                    <div class="bg-gray-800 p-8 rounded-lg">
                        <p class="text-xl md:text-2xl font-medium mb-6">${q.q}</p>
                        <div class="space-y-4">
                            ${options.map(option => `
                                <button class="answer-btn block w-full text-left bg-gray-700 p-4 rounded-lg hover:bg-purple-700 transition-colors duration-200" onclick="checkAnswer('${option.replace(/'/g, "\\'")}')">
                                    ${option}
                                </button>
                            `).join('')}
                        </div>
                        <div id="feedback-container" class="mt-6"></div>
                    </div>
                </div>
            `;
        }
    	
        function nextQuestion() {
            currentQuestionIndex++;
            loadQuestion();
        }
    	
        function generateAiButtonHtml(question, isCorrect) {
            if (!question.subjectType || !question.subjectName) {
                return '';
            }
        	
            let buttonText = isCorrect ? `➡️ Dive Deeper on ${question.subjectName}` : `💡 Learn More about ${question.subjectName}`;
            if (question.subjectType === 'dish' || question.subjectType === 'wine_pairing') {
                 buttonText = isCorrect ? `➡️ Explain the Pairing for ${question.subjectName}` : `💡 Learn about Pairing with ${question.subjectName}`;
            }

            return `<button onclick="handleAiRequest('${question.subjectType}', '${question.subjectName.replace(/'/g, "\\'")}')" class="mt-4 bg-purple-600 hover:bg-purple-500 text-white font-bold py-2 px-4 rounded text-sm">${buttonText}</button>`;
        }

        function checkAnswer(selectedOption) {
            const q = questions[currentQuestionIndex];
            const isCorrect = selectedOption === q.a;
            const feedbackContainer = document.getElementById('feedback-container');
        	
            let feedbackHtml = '';
            if (isCorrect) {
                score++;
                const questionText = q.q;
                let correctLog = JSON.parse(localStorage.getItem('correctlyAnsweredQuestions')) || {};
                if (!correctLog[currentModule]) {
                    correctLog[currentModule] = [];
                }
                if (!correctLog[currentModule].includes(questionText)) {
                    correctLog[currentModule].push(questionText);
                }
                localStorage.setItem('correctlyAnsweredQuestions', JSON.stringify(correctLog));

                feedbackHtml = `<div class="p-4 rounded-lg bg-green-900 border border-green-700">
                                    <p class="font-bold text-green-300">Correct!</p>
                                    <p class="text-green-400">${q.a}</p>
                                    ${generateAiButtonHtml(q, true)}
                                </div>`;
            } else {
                feedbackHtml = `<div class="p-4 rounded-lg bg-red-900 border border-red-700">
                                    <p class="font-bold text-red-300">Incorrect.</p>
                                    <p class="text-red-400">The correct answer was: ${q.a}</p>
                                     ${generateAiButtonHtml(q, false)}
                                </div>`;
            }

            feedbackContainer.innerHTML = feedbackHtml;
            document.querySelectorAll('.answer-btn').forEach(btn => {
                btn.disabled = true;
                if(btn.innerText === q.a) {
                    btn.classList.remove('hover:bg-purple-700');
                    btn.classList.add('bg-green-700');
                } else if (btn.innerText === selectedOption) {
                    btn.classList.remove('hover:bg-purple-700');
                    btn.classList.add('bg-red-700');
                }
            });
            feedbackContainer.innerHTML += `<button onclick="nextQuestion()" class="mt-4 w-full bg-purple-700 hover:bg-purple-600 text-white font-bold py-2 px-4 rounded">Continue</button>`;
        }
    	
        // --- Historian's Scroll Logic ---
        function loadHistorianQuestion() {
            if (currentQuestionIndex >= questions.length) {
                showEndGameModal();
                return;
            }

            const q = questions[currentQuestionIndex];
            userTimeline = [];
        	
            const eventsWithIds = q.events.map((event, index) => ({ ...event, id: `${currentQuestionIndex}-${index}` }));
            historianAvailableEvents = shuffleArray(eventsWithIds);

            gameScreen.innerHTML = `
                <div class="w-full max-w-4xl">
                    <div class="flex justify-between items-center mb-2">
                        <button onclick="returnToMenu()" class="bg-gray-700 hover:bg-gray-600 text-white font-bold py-1 px-3 rounded text-sm">← Menu</button>
                        <p class="text-center text-gray-400">Question ${currentQuestionIndex + 1} / ${questions.length} | Score: ${score}</p>
                    </div>
                    <div class="bg-gray-800 p-6 rounded-lg">
                        <p class="text-xl text-center font-medium mb-6">${q.question}</p>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <h3 class="font-bold text-lg mb-2 text-purple-400 text-center">Available Events</h3>
                                <div id="available-events" class="space-y-2">
                                    ${historianAvailableEvents.map(event => `
                                        <button data-id="${event.id}" class="timeline-item w-full text-left bg-gray-700 p-3 rounded hover:bg-purple-800 transition-colors duration-200">
                                            ${event.text}
                                        </button>
                                    `).join('')}
                                </div>
                            </div>
                            <div>
                                <h3 class="font-bold text-lg mb-2 text-purple-400 text-center">Your Timeline (Earliest to Latest)</h3>
                                <div id="user-timeline" class="space-y-2 bg-gray-900 p-3 rounded-lg min-h-[200px]"></div>
                            </div>
                        </div>
                        <div class="text-center mt-6">
                            <button id="submit-timeline" class="bg-purple-700 hover:bg-purple-600 text-white font-bold py-3 px-8 rounded-lg" onclick="checkTimeline()">Submit</button>
                        </div>
                    </div>
                </div>
            `;
        	
            document.querySelectorAll('#available-events .timeline-item').forEach(button => {
                button.addEventListener('click', (e) => {
                    const eventId = e.currentTarget.dataset.id;
                    const event = historianAvailableEvents.find(ev => ev.id === eventId);
                    if (event && !userTimeline.some(e => e.id === event.id)) {
                        userTimeline.push(event);
                        e.currentTarget.classList.add('selected', 'opacity-50', 'cursor-not-allowed');
                        e.currentTarget.disabled = true;
                        renderUserTimeline();
                    }
                });
            });
        }
    	
        function renderUserTimeline() {
            const timelineContainer = document.getElementById('user-timeline');
            timelineContainer.innerHTML = userTimeline.map((event, index) => `
                <div class="bg-purple-900 p-3 rounded flex items-center justify-between">
                    <span>${index + 1}. ${event.text}</span>
                    <button class="text-red-400 hover:text-red-200 font-bold" onclick="removeFromTimeline('${event.id}')">&times;</button>
                </div>
            `).join('');
        }

        function removeFromTimeline(eventId) {
            const indexToRemove = userTimeline.findIndex(event => event.id === eventId);

            if (indexToRemove > -1) {
                userTimeline.splice(indexToRemove, 1);
                const buttonToReEnable = document.querySelector(`#available-events .timeline-item[data-id="${eventId}"]`);
                if (buttonToReEnable) {
                    buttonToReEnable.disabled = false;
                    buttonToReEnable.classList.remove('selected', 'opacity-50', 'cursor-not-allowed');
                }
                renderUserTimeline();
            }
        }

        function checkTimeline() {
            const q = questions[currentQuestionIndex];
            const correctTimeline = [...q.events].sort((a, b) => a.date - b.date);
            let isCompletelyCorrect = userTimeline.length === correctTimeline.length;
        	
            if (isCompletelyCorrect) {
                for (let i = 0; i < correctTimeline.length; i++) {
                    if (userTimeline[i].text !== correctTimeline[i].text) {
                        isCompletelyCorrect = false;
                        break;
                    }
                }
            }
        	
            if(isCompletelyCorrect) {
                score++;
            }

            const userTimelineHtml = userTimeline.map((event, i) => {
                const isEventInCorrectPosition = correctTimeline[i] && correctTimeline[i].text === event.text;
                const borderColor = isEventInCorrectPosition ? 'border-green-500' : 'border-red-500';
                return `<li class="p-2 bg-gray-700 rounded border-2 ${borderColor}">${event.text}</li>`;
            }).join('');

            const correctTimelineHtml = correctTimeline.map(e => 
                `<li class="p-2 bg-gray-700 rounded border-2 border-green-500">${e.text} <span class="text-gray-400 text-sm">(${e.date})</span></li>`
            ).join('');
        	
            const feedbackContent = `
                <div class="p-6">
                    <h2 class="text-2xl font-bold mb-4 ${isCompletelyCorrect ? 'text-green-400' : 'text-yellow-400'}">${isCompletelyCorrect ? 'Perfect!' : 'Review Your Timeline'}</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <h3 class="font-bold text-lg mb-2 text-purple-400">Your Timeline</h3>
                            <ol class="list-decimal list-inside space-y-2">
                                ${userTimelineHtml}
                            </ol>
                        </div>
                        <div>
                            <h3 class="font-bold text-lg mb-2 text-purple-400">Correct Timeline</h3>
                            <ol class="list-decimal list-inside space-y-2">
                                ${correctTimelineHtml}
                            </ol>
                        </div>
                    </div>
                    <button onclick="nextHistorianQuestion()" class="mt-6 w-full bg-purple-700 hover:bg-purple-600 text-white font-bold py-2 px-4 rounded">Continue</button>
                </div>
            `;
            showModal(feedbackContent);
        }

        function nextHistorianQuestion() {
            hideModal();
            currentQuestionIndex++;
            loadHistorianQuestion();
        }

        // --- Mastery Logic ---
        function checkGlobalMastery() {
            if (sessionStorage.getItem('globalMasteryAcknowledged')) {
                return;
            }

            const modulesToMaster = ['terroir', 'ampelographer', 'lawmaker', 'gastronome', 'critic'];
            const correctLog = JSON.parse(localStorage.getItem('correctlyAnsweredQuestions')) || {};
        	
            let allMastered = true;
            for (const module of modulesToMaster) {
                const totalQuestions = gameData[module].questions.length;
                const correctlyAnswered = (correctLog[module] || []).length;
                if (correctlyAnswered < totalQuestions) {
                    allMastered = false;
                    break;
                }
            }

            if (allMastered) {
                showGlobalMasteryModal();
            }
        }

        function showGlobalMasteryModal() {
            const content = `
                <div class="p-6 text-center">
                    <h2 class="text-2xl font-bold mb-4 text-purple-400">Congratulations, Wine Master!</h2>
                    <p class="mb-4 text-gray-300">You have demonstrated exceptional knowledge by correctly answering every question across all core modules. You have truly mastered the Côte de Beaune!</p>
                    <p class="mb-6 text-gray-300">To keep your expertise sharp, continue to practice with the <strong>Flashcard Study</strong> decks.</p>
                    <button onclick="closeGlobalMasteryModal()" class="w-full bg-purple-700 hover:bg-purple-600 text-white font-bold py-2 px-4 rounded">Continue</button>
                </div>
            `;
            showModal(content);
        }

        function closeGlobalMasteryModal() {
            sessionStorage.setItem('globalMasteryAcknowledged', 'true');
            hideModal();
        }

        // --- Flashcard Logic ---
        function showFlashcardTopicSelection() {
            const topics = Object.keys(flashcardData);
            const content = `
                <div class="p-6">
                    <h2 class="text-2xl font-bold mb-4 text-purple-400">Build Your Flashcard Deck</h2>
                    <p class="mb-6 text-gray-300">Select the topics you want to study. These decks cover the entire source document.</p>
                    <div id="flashcard-topics" class="space-y-2 mb-4">
                        ${topics.map(topic => `
                            <label class="flex items-center bg-gray-700 p-3 rounded-lg hover:bg-gray-600 cursor-pointer">
                                <input type="checkbox" class="form-checkbox h-5 w-5 text-purple-600 bg-gray-800 border-gray-600 rounded focus:ring-purple-500" data-topic="${topic}">
                                <span class="ml-3 text-white">${gameData[topic].title}</span>
                            </label>
                        `).join('')}
                    </div>
                     <label class="flex items-center bg-gray-700 p-3 rounded-lg hover:bg-gray-600 cursor-pointer mb-6">
                        <input type="checkbox" id="select-all-topics" class="form-checkbox h-5 w-5 text-purple-600 bg-gray-800 border-gray-600 rounded focus:ring-purple-500">
                        <span class="ml-3 text-white font-bold">Select All</span>
                    </label>
                    <button onclick="startFlashcardSession()" class="w-full bg-purple-700 hover:bg-purple-600 text-white font-bold py-2 px-4 rounded">Start Studying</button>
                </div>
            `;
            showModal(content);
        	
            document.getElementById('select-all-topics').addEventListener('change', (e) => {
                document.querySelectorAll('#flashcard-topics input[type="checkbox"]').forEach(checkbox => {
                    checkbox.checked = e.target.checked;
                });
            });
        }

        function startFlashcardSession() {
            flashcardDeck = [];
            const selectedTopics = Array.from(document.querySelectorAll('#flashcard-topics input:checked')).map(cb => cb.dataset.topic);

            if (selectedTopics.length === 0) {
                showModal(`<div class="p-6 text-center">
                    <p class="text-lg text-yellow-400 mb-4">Please select at least one topic.</p>
                    <button onclick="showFlashcardTopicSelection()" class="w-full bg-purple-700 hover:bg-purple-600 text-white font-bold py-2 px-4 rounded">Go Back</button>
                </div>`);
                return;
            }

            selectedTopics.forEach(topic => {
                if (flashcardData[topic]) {
                    flashcardDeck.push(...flashcardData[topic]);
                }
            });

            flashcardDeck = shuffleArray(flashcardDeck);
            currentFlashcardIndex = 0;
            hideModal();
            mainMenu.classList.add('hidden');
            gameScreen.classList.remove('hidden');
            loadFlashcard();
        }

        function loadFlashcard() {
            if (flashcardDeck.length === 0) {
                gameScreen.innerHTML = `<div class="text-center">
                    <p class="text-2xl mb-4">No topics selected.</p>
                    <button onclick="returnToMenu()" class="bg-purple-700 hover:bg-purple-600 text-white font-bold py-2 px-4 rounded">Main Menu</button>
                </div>`;
                return;
            }
            const card = flashcardDeck[currentFlashcardIndex];
            gameScreen.innerHTML = `
                <div class="w-full max-w-2xl flex flex-col items-center">
                    <p class="text-gray-400 mb-4">${currentFlashcardIndex + 1} / ${flashcardDeck.length}</p>
                    <div class="flashcard-container w-full h-80 mb-6">
                        <div class="flashcard" onclick="this.classList.toggle('is-flipped')">
                            <div class="flashcard-face flashcard-front text-2xl font-semibold">${card.q}</div>
                            <div class="flashcard-face flashcard-back text-xl">${card.a}</div>
                        </div>
                    </div>
                    <div class="flex justify-between w-full">
                        <button id="prev-card" class="bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 px-6 rounded">&larr; Previous</button>
                        <button onclick="returnToMenu()" class="bg-red-700 hover:bg-red-600 text-white font-bold py-2 px-6 rounded">End Session</button>
                        <button id="next-card" class="bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 px-6 rounded">Next &rarr;</button>
                    </div>
                </div>
            `;
        	
            document.getElementById('prev-card').addEventListener('click', () => {
                if (currentFlashcardIndex > 0) {
                    currentFlashcardIndex--;
                    loadFlashcard();
                }
            });
            document.getElementById('next-card').addEventListener('click', () => {
                if (currentFlashcardIndex < flashcardDeck.length - 1) {
                    currentFlashcardIndex++;
                    loadFlashcard();
                }
            });
        }
    	
        // --- AI Integration ---
        async function handleAiRequest(subjectType, subjectName) {
            if (!userApiKey) {
                showModal(`<div class="p-6 text-center">
                    <h2 class="text-2xl font-bold mb-4 text-yellow-400">API Key Required</h2>
                    <p class="mb-4 text-gray-300">Please set your Google AI API key in the 'AI Settings' on the main menu to use this feature.</p>
                    <button onclick="hideModal()" class="w-full bg-purple-700 hover:bg-purple-600 text-white font-bold py-2 px-4 rounded">Close</button>
                </div>`);
                return;
            }

            let prompt;
            let title;
            const region = "Côte de Beaune";

            switch (subjectType) {
                case 'clone':
                case 'grape':
                    title = `Ampelography Profile: ${subjectName}`;
                    prompt = `You are a master ampelographer and wine educator with a specialization in ${region}. Your task is to profile the grape or clone: ${subjectName}. Your response must follow this strict pyramid of importance: 1. The subject's specific expression and role within ${region}. 2. Its general viticultural characteristics as they manifest in ${region}'s climate. 3. Its history within the region. Your entire response must be framed through the lens of ${region}. Synthesize information from authoritative sources, but always prioritize the context of ${region}. Structure your response with the following sections: Overview and History in ${region}, Viticultural Characteristics in ${region}, and Typical ${region} Wine Profile. Format the output in simple HTML.`;
                    break;
                case 'wine':
                case 'producer':
                case 'vintage':
                case 'place':
                case 'wine_style':
                    title = `Critic's Focus: ${subjectName}`;
                    prompt = `You are a world-renowned wine critic specializing exclusively in the wines of ${region}. Your task is to write a professional profile for the following iconic ${region} topic: ${subjectName}. Your analysis must adhere to a strict pyramid of importance: 1) The specific subject's style or character. 2) The character of its specific appellation within ${region}. 3) The general characteristics of ${region}. Do not mention wines from other regions unless making a direct, essential stylistic comparison. Synthesize information from authoritative sources like Burghound, Vinous, and Decanter, but ensure the final note is your own expert synthesis. Format in simple HTML.`;
                    break;
                case 'dish':
                case 'wine_pairing':
                    title = `Gastronomic Pairing: ${subjectName}`;
                    prompt = `You are a master sommelier and food theorist specializing in the cuisine and wine of ${region}. Your task is to explain the classic wine pairing for the dish: ${subjectName}. Your explanation must follow this strict pyramid of importance: 1. The specific characteristics of the dish as found in the region. 2. The typical profile of a ${region} wine that pairs with it. 3. The underlying gastronomic principles (complement, contrast, texture) that make the pairing successful within the context of the region's culture. Synthesize information from expert sources, but frame your entire response within the context of ${region}. Format in simple HTML.`;
                    break;
                case 'ingredient':
                case 'gastronomy':
                case 'liqueur':
                case 'spirit':
                    title = `Ingredient Focus: ${subjectName}`;
                    prompt = `You are a food and wine expert specializing in the cuisine of Burgundy and the ${region}. Your task is to provide a detailed overview of the ingredient or beverage: ${subjectName}. Your response must follow this strict pyramid of importance: 1. How this ingredient is used or produced in the local culture of ${region}. 2. Its typical flavor and aromatic profile. 3. How its profile might be reflected in or complement the local wines. Synthesize from authoritative sources. Format in simple HTML.`;
                    break;
                default:
                    title = `Expert Overview: ${subjectName}`;
                    prompt = `You are a wine and food expert specializing in ${region}. Provide a concise and informative overview of the following topic: ${subjectName}, ensuring your response is strictly relevant to its context within ${region}. Format in simple HTML.`;
            }
        	
            showModal(`<div class="p-6 text-center">
                <h2 class="text-2xl font-bold mb-4 text-purple-400">Generating AI Response...</h2>
                <div class="animate-spin rounded-full h-16 w-16 border-b-2 border-white mx-auto"></div>
                <p class="mt-4 text-gray-400">Please wait, contacting the master sommelier...</p>
            </div>`);

            try {
                const chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
                const payload = { contents: chatHistory };
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${userApiKey}`;
            	
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error.message || `API request failed with status ${response.status}`);
                }

                const result = await response.json();
            	
                if (result.candidates && result.candidates[0].content && result.candidates[0].content.parts[0]) {
                    const text = result.candidates[0].content.parts[0].text;
                    const aiContent = `
                        <div class="p-6">
                            <div class="flex justify-between items-center mb-4">
                                <h2 class="text-2xl font-bold text-purple-400">${title}</h2>
                                <button onclick="hideModal()" class="text-gray-400 hover:text-white text-2xl">&times;</button>
                            </div>
                            <div class="prose prose-invert prose-purple max-w-none">${text.replace(/\n/g, '<br>')}</div>
                        </div>`;
                    showModal(aiContent);
                } else {
                     throw new Error("Invalid response structure from API.");
                }

            } catch (error) {
                console.error("AI Generation Error:", error);
                const errorContent = `
                    <div class="p-6">
                        <h2 class="text-2xl font-bold mb-4 text-red-400">Error</h2>
                        <p class="mb-4 text-gray-300">Could not generate AI response. Please check your API key and network connection.</p>
                        <p class="text-sm text-gray-500 bg-gray-900 p-2 rounded">${error.message}</p>
                        <button onclick="hideModal()" class="mt-4 w-full bg-purple-700 hover:bg-purple-600 text-white font-bold py-2 px-4 rounded">Close</button>
                    </div>`;
                showModal(errorContent);
            }
        }

        // --- Utility Functions ---
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        // --- Initial Load ---
        window.onload = showWelcomeModal;

    </script>
</body>
</html>
